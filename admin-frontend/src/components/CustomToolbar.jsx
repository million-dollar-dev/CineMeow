import * as React from "react";
import { styled } from "@mui/material/styles";
import {
    Toolbar,
    ToolbarButton,
    ColumnsPanelTrigger,
    FilterPanelTrigger,
    ExportCsv,
    ExportPrint,
    QuickFilter,
    QuickFilterControl,
    QuickFilterClear,
    QuickFilterTrigger,
} from "@mui/x-data-grid";
import {
    Box,
    Tooltip,
    Menu,
    Badge,
    MenuItem,
    Divider,
    TextField,
    InputAdornment,
    Button
} from "@mui/material";
import ViewColumnOutlinedIcon from '@mui/icons-material/ViewColumnOutlined';
import FilterListOutlinedIcon from '@mui/icons-material/FilterListOutlined';
import FileDownloadOutlinedIcon from '@mui/icons-material/FileDownloadOutlined';
import CancelIcon from "@mui/icons-material/Cancel";
import SearchIcon from "@mui/icons-material/Search";

const StyledQuickFilter = styled(QuickFilter)({
    display: "grid",
    alignItems: "center",
});

const StyledToolbarButton = styled(ToolbarButton)(({ theme, ownerState }) => ({
    gridArea: "1 / 1",
    width: "min-content",
    height: "min-content",
    zIndex: 1,
    opacity: ownerState.expanded ? 0 : 1,
    pointerEvents: ownerState.expanded ? "none" : "auto",
    transition: theme.transitions.create(["opacity"]),
}));

const StyledTextField = styled(TextField)(({ theme, ownerState }) => ({
    gridArea: "1 / 1",
    overflowX: "clip",
    width: ownerState.expanded ? 260 : "var(--trigger-width)",
    opacity: ownerState.expanded ? 1 : 0,
    transition: theme.transitions.create(["width", "opacity"]),
}));

export default function CustomToolbar({ handleAddClick }) {
    const [exportMenuOpen, setExportMenuOpen] = React.useState(false);
    const exportMenuTriggerRef = React.useRef(null);

    return (
        <Toolbar sx={{ justifyContent: "space-between", px: 2, py: 4 }}>
            <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                <Tooltip title="Columns">
                    <ColumnsPanelTrigger render={<ToolbarButton />}>
                        <ViewColumnOutlinedIcon fontSize="medium" />
                    </ColumnsPanelTrigger>
                </Tooltip>

                <Tooltip title="Filters">
                    <FilterPanelTrigger
                        render={(props, state) => (
                            <ToolbarButton {...props} color="default">
                                <Badge
                                    badgeContent={state.filterCount}
                                    color="primary"
                                    variant="dot"
                                >
                                    <FilterListOutlinedIcon fontSize="medium" />
                                </Badge>
                            </ToolbarButton>
                        )}
                    />
                </Tooltip>

                <Divider
                    orientation="vertical"
                    variant="middle"
                    flexItem
                    sx={{ mx: 0.5 }}
                />

                <Tooltip title="Export">
                    <ToolbarButton
                        ref={exportMenuTriggerRef}
                        id="export-menu-trigger"
                        aria-controls="export-menu"
                        aria-haspopup="true"
                        aria-expanded={exportMenuOpen ? "true" : undefined}
                        onClick={() => setExportMenuOpen(true)}
                    >
                        <FileDownloadOutlinedIcon fontSize="medium" />
                    </ToolbarButton>
                </Tooltip>

                <Menu
                    id="export-menu"
                    anchorEl={exportMenuTriggerRef.current}
                    open={exportMenuOpen}
                    onClose={() => setExportMenuOpen(false)}
                    anchorOrigin={{ vertical: "bottom", horizontal: "right" }}
                    transformOrigin={{ vertical: "top", horizontal: "right" }}
                >
                    <ExportPrint
                        render={<MenuItem />}
                        onClick={() => setExportMenuOpen(false)}
                    >
                        Print
                    </ExportPrint>
                    <ExportCsv
                        render={<MenuItem />}
                        onClick={() => setExportMenuOpen(false)}
                    >
                        Download as CSV
                    </ExportCsv>
                </Menu>

                {/* Quick Search */}
                <StyledQuickFilter>
                    <QuickFilterTrigger
                        render={(triggerProps, state) => (
                            <Tooltip title="Search" enterDelay={0}>
                                <StyledToolbarButton
                                    {...triggerProps}
                                    ownerState={{ expanded: state.expanded }}
                                    color="default"
                                    aria-disabled={state.expanded}
                                >
                                    <SearchIcon fontSize="medium" />
                                </StyledToolbarButton>
                            </Tooltip>
                        )}
                    />
                    <QuickFilterControl
                        render={({ ref, ...controlProps }, state) => (
                            <StyledTextField
                                {...controlProps}
                                ownerState={{ expanded: state.expanded }}
                                inputRef={ref}
                                aria-label="Search"
                                placeholder="Search..."
                                size="small"
                                slotProps={{
                                    input: {
                                        startAdornment: (
                                            <InputAdornment position="start">
                                                <SearchIcon fontSize="medium" />
                                            </InputAdornment>
                                        ),
                                        endAdornment: state.value ? (
                                            <InputAdornment position="end">
                                                <QuickFilterClear
                                                    edge="end"
                                                    size="small"
                                                    aria-label="Clear search"
                                                    material={{ sx: { marginRight: -0.75 } }}
                                                >
                                                    <CancelIcon fontSize="medium" />
                                                </QuickFilterClear>
                                            </InputAdornment>
                                        ) : null,
                                        ...controlProps.slotProps?.input,
                                    },
                                    ...controlProps.slotProps,
                                }}
                            />
                        )}
                    />
                </StyledQuickFilter>
            </Box>

            {/* Right group: Add button */}
            <Button
                variant="contained"
                color="primary"
                onClick={handleAddClick}
                sx={{
                    borderRadius: 1,
                }}
            >
                Thêm mới
            </Button>
        </Toolbar>
    );
}